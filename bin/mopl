#!/usr/bin/env bash
# ------------------------------------------------------------------
#title           :mopl
#description     :Easily install Camunda Desktop Modeler plugins.
#author          :Niklas Kiefer
#usage           :mopl -hv
#bash-version    :Bash v4
# ------------------------------------------------------------------

VERSION=0.1.0
USAGE="Usage: mopl -hv"

# TODO(pinussilvestrus): make path configurable
# TODO(pinussilvestrus): make cross platform
PLUGINS_PATH="${HOME}/Library/Application Support/camunda-modeler/resources/plugins"
PLUGINS_REPOSITORY='https://raw.githubusercontent.com/camunda/camunda-modeler-plugins/master/README.md'
URL_REGEX='(https:\/\/.*?)\)'
MD_LINK_REGEX='^\*(\s)*\[.*?\]\((https:\/\/.*?).*?\)'
PLUGINS_BLACKLIST=('https://docs.camunda.io/docs/components/modeler/desktop-modeler/plugins/')

set -Eeuo pipefail

function print_message {
  echo "[mopl] $1"
}

# TODO(pinussilvestrus): also offer local plugins, as https://github.com/camunda/camunda-modeler-plugins/tree/master/camunda-transaction-boundaries-plugin
function crawl_plugins {
  curl --silent "$PLUGINS_REPOSITORY" | grep -Eo "${MD_LINK_REGEX}"
}

plugins=()
# TODO(pinussilvestrus): also retrieve correct package name (not only URLs) 
function transform_plugins {
  plugin_urls=($(echo "$1" | grep -Eo "${URL_REGEX}"))

  # remove last char ")"
  for (( i=0; i<${#plugin_urls[@]}; i++ )); do
    plugin_urls[$i]=${plugin_urls[$i]::-1} # remove last char
  done

  # remove blacklist items
  for del in "${PLUGINS_BLACKLIST[@]}"; do
    for i in "${!plugin_urls[@]}"; do
      if [[ ${plugin_urls[i]} = $del ]]; then
        unset 'plugin_urls[i]'
      fi
    done
  done

  # set to data struct
  for i in "${!plugin_urls[@]}"; do
    plugins[$i]=${plugin_urls[$i]}
  done
}

# TODO(pinussilvestrus): make keyboard accessible
function select_plugin {
  PS3='Select number: '
  select opt in "${plugins[@]}"
  do
    if  [ -z "$opt" ]; then
      print_message "invalid option"
    else
      break
    fi
  done

  echo "$opt"
}

# TODO(pinussilvestrus): make version configurable
function download_plugin {
  plugin_download_url="${1}/tarball/master"
  curl --silent -L "${plugin_download_url}" | tar zx -C "$PLUGINS_PATH"
}

# get args
while getopts ":vh" optname
  do
    case "$optname" in
      "v")
        print_message "Version $VERSION"
        exit 0;
        ;;
      "h")
        print_message "$USAGE"
        exit 0;
        ;;
      "?")
        print_message "Unknown option $OPTARG"
        exit 0;
        ;;
      ":")
        print_message "No argument value for option $OPTARG"
        exit 0;
        ;;
      *)
        print_message "Unknown error while processing options"
        exit 0;
        ;;
    esac
  done

# crawl plugins
print_message "Crawling plugins from camunda/camunda-modeler-plugins..."
raw_plugins=$(crawl_plugins)

# define plugins struct
transform_plugins "${raw_plugins}"

# prompt available plugins
print_message "Available plugins to install:"
opt=$(select_plugin)

# download plugin
print_message "Downloading from ${opt}/tarball/master..."
download_plugin "$opt"
print_message "Success!"